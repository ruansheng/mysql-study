## TCP首部字段
![TCP首部字段](https://github.com/ruansheng/technology-study/blob/master/images/tcp_header.png)

### 源端口、目标端口
```
4字节:各占2个字节,共4个字节
TCP报文头部里面没有源ip地址和目标ip地址，ip地址是IP层协议的事
TCP报文头部有源端口号、目标端口号
```

### 序列号(Sequence number)
```
4字节
序号范围是【0，2^32 - 1】，共2^32（即4294967296）个序号，序号增加到2^32-1后，下一个序号就又回到0
TCP是面向字节流的协议，通过TCP传输的字节流的每个字节都分配了序列号，序列号值本报文段的第一个字节的序列号
序列号加上报文的长度就能确定传输的是哪一段数据
SYN报文中，序列号用于交换彼此的初始化序列号；在其它报文中，序列号用于保证包的顺序
```

### 确认号(Acknowledgment number)
```
4字节
确认号是期望收到对方下一个报文段的第一个数据字节的序号，小于此确认号的所有字节都已经收到
注意:
1.不是所有的包都需要确认
2.不是收到了数据包就立马需要确认，可以延长一会再确认
3.Ack包本身不需要被确认，否则就会无穷无尽死循环
4.确认号永远是表示小于此确认号的字节都已经收到
```

### 数据偏移
```
0.5字节:占4位
它指出TCP报文段的数据起始处距离TCP报文段的起始处有多远
这个字段实际上是指出TCP报文段的首部长度
由于首部中还有长度不确定的选项字段，因此数据偏移字段是必要的，但应注意，“数据偏移”的单位是32位字（即以4字节的字为计算单位）

由于4位二进制数能表示的最大十进制数字是15，因此数据偏移的最大值是60字节，这也是TCP首部的最大字节（即选项长度不能超过40字节）。
```

### 保留
```
0.75字节:占6位
保留为今后使用，但目前应置为0
```

### 控制位
```
0.75字节:占6位
紧急URG（URGent）:当URG=1时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快发送（相当于高优先级的数据），而不要按原来的排队顺序来传送。
确认ACK（ACKnowledgment）:仅当ACK = 1时确认号字段才有效，当ACK = 0时确认号无效。TCP规定，在连接建立后所有的传送的报文段都必须把ACK置为1。
推送 PSH（PuSH）:  当两个应用进程进行交互式的通信时，有时在一端的应用进程希望在键入一个命令后立即就能收到对方的响应。在这种情况下，TCP就可以使用推送（push）操作。这时，发送方TCP把PSH置为1，并立即创建一个报文段发送出去。接收方TCP收到PSH=1的报文段，就尽快地（即“推送”向前）交付接收应用进程。而不用再等到整个缓存都填满了后再向上交付。
复位RST（ReSeT）:  当RST=1时，表明TCP连接中出现了严重错误（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立传输连接。RST置为1还用来拒绝一个非法的报文段或拒绝打开一个连接。
同步SYN（SYNchronization）: 在连接建立时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使SYN=1和ACK=1，因此SYN置为1就表示这是一个连接请求或连接接受报文。
终止FIN（FINis，意思是“完”“终”）: 用来释放一个连接。当FIN=1时，表明此报文段的发送发的数据已发送完毕，并要求释放运输连接。
```

### 窗口
```
2字节
窗口值是【0，2^16-1】之间的整数。窗口指的是发送本报文段的一方的接受窗口（而不是自己的发送窗口）
窗口值告诉对方：从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量（以字节为单位）。
之所以要有这个限制，是因为接收方的数据缓存空间是有限的。总之，窗口值作为接收方让发送方设置其发送窗口的依据。
总之：窗口字段明确指出了现在允许对方发送的数据量。窗口值经常在动态变化。
```

### 检验和
```
2字节
检验和字段检验的范围包括首部和数据这两部分。
和UDP用户数据报一样，在计算检验和时，要在TCP报文段的前面加上12字节的伪首部。伪首部的格式和UDP用户数据报的伪首部一样。
但应把伪首部第4个字段中的17改为6（TCP的协议号是6）；把第5字段中的UDP中的长度改为TCP长度。接收方收到此报文段后，仍要加上这个伪首部来计算检验和。若使用TPv6,则相应的伪首部也要改变。
```

### 紧急指针
```
2字节
紧急指针仅在URG=1时才有意义，它指出本报文段中的紧急数据的字节数（紧急数据结束后就是普通数据） 。
因此，在紧急指针指出了紧急数据的末尾在报文段中的位置。当所有紧急数据都处理完时，TCP就告诉应用程序恢复到正常操作。值得注意的是，即使窗口为0时也可以发送紧急数据。
```

### 选项
![TCP Option](https://github.com/ruansheng/technology-study/blob/master/images/tcp_option.png)
```
<=40字节
长度可变，最长可达4字节。当没有使用“选项”时，TCP的首部长度是20字节。

每个选项的开始都是1个Byte的kind字段，说明选项的类型，Kind为0/1的时候，选项只占1个Byte，其他选项在kind字段后面还有len字节，说明总长度包括kind和len的字节。

1.TCP最初只规定了一种选项，即最大报文段长度MSS（Maximum Segment Szie）。
注意MSS这个名词含义。MSS是每一个TCP报文段中的数据字段的最大长度。
数据字段加上TCP首部才等于整个的TCP报文段。所以MSS并不是整个TCP报文段的最大长度，而是“TCP报文段长度减去TCP首部长度”。
若主机未填写这一项，则MSS的默认值是536字节长。

后来又增加了几个选项如窗口扩大选项、时间戳选项等。
2.窗口扩大选项是为了扩大窗口。我们知道，TCP首部中窗口字段长度是16位，因此最大的窗口大小为64K字节。虽然这对早期的网络是足够用的，但对于包含卫星信道的网络，传播时延和宽带都很大，要获得高吞吐量需要更大的窗口大小。
窗口扩大选项占3字节，其中有一个字节表示移位值S。新的窗口值等于TCP首部中的窗口位数从16增大到（16+S）。移位值允许使用的最大值是14，相当于窗口最大值增大到2^（16+14）-1=2^30-1。
窗口扩大选项可以在双方初始建立TCP连接时进行协商。如果连接的某一端实现了窗口扩大，当它不再需要扩大其窗口时，可发送S=0选项，使窗口大小回到16。

3.时间戳选项占10字节，其中最主要的字段是时间戳字段（4字节）和时间戳回送回答字段（4字节）。时间戳选项有以下两个概念：
第一、 用来计算往返时间RTT。发送方在发送报文段时把当前时钟的时间值放入时间戳字段，接收方在确认该报文段时把时间戳字段复制到时间戳回送回答字段。因此，发送方在收到确认报文后，可以准确地计算出RTT来。
第二、 用于处理TCP序号超过2^32的情况，这又称为防止序号绕回PAWS。我们知道，TCP报文段的序号只有32位，而每增加2^32个序号就会重复使用原来用过的序号。当使用高速网络时，在一次TCP连接的数据传送中序号很可能被重复使用。例如，当使用1.5Mbit/s的速度发送报文段时，序号重复要6小时以上。但若用2.5Gbit/s的速率发送报文段，则不到14秒钟序号就会重复。为了使接收方能够把新的报文段和迟到很久的报文段区分开，则可以在报文段中加上这种时间戳。
```
![TCP Option](https://github.com/ruansheng/technology-study/blob/master/images/tcp_option_kind.png)
```
从图中可以看到：
0~3 Byte ： MSS 512
4~7 Byte ： nop，wscale 0
8~11Byte：nop，nop，timestamp
12~15 Byte：146647
16~19 Byte：0 最少4个字节对齐
```

### 填充
```
填充是为了使TCP首部为4byte的整数倍。
```